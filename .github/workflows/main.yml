name: CI/CD Pipeline

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up SSH Agent
        uses: webfactory/ssh-agent@v0.7.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Install frontend dependencies
        run: npm install

      - name: Build frontend
        run: npm run build

      - name: Install backend dependencies
        run: npm install --prefix server

      - name: Install Puppeteer dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libatk1.0-0 libc6 libcairo2 libcups2 libdbus-1-3 libexpat1 libfontconfig1 libgcc1 libgdk-pixbuf2.0-0 libglib2.0-0 libgtk-3-0 libnspr4 libnss3 libpango-1.0-0 libpangocairo-1.0-0 libstdc++6 libx11-6 libx11-xcb1 libxcb1 libxcomposite1 libxcursor1 libxdamage1 libxext6 libxfixes3 libxi6 libxrandr2 libxrender1 libxss1 libxtst6 libappindicator3-1 libnss3 libxkbcommon-x11-0 fonts-liberation libgbm-dev libasound2-dev libatk-bridge2.0-dev libgtk-3-dev
          npm install --prefix server puppeteer --unsafe-perm=true --allow-root

      - name: Deploy to VPS
        env:
          SSH_HOST: 104.223.123.201
          SSH_USER: root
        run: |
          set -x
          
          ssh-keyscan -H $SSH_HOST >> ~/.ssh/known_hosts
          
          ssh $SSH_USER@$SSH_HOST "sudo mkdir -p /var/www/booknow.hair/html"
          
          echo "Deploying frontend..."
          scp -o StrictHostKeyChecking=no -r dist/* $SSH_USER@$SSH_HOST:/var/www/booknow.hair/html/

          echo "Deploying backend..."
          ssh $SSH_USER@$SSH_HOST "sudo mkdir -p /var/www/booknow.hair/server"
          # Exclude node_modules from scp as it can be very large and should be installed on the server
          scp -o StrictHostKeyChecking=no -r server/index.js server/package.json server/package-lock.json server/README.md server/public server/routes server/scripts server/services server/server.js server/start.js $SSH_USER@$SSH_HOST:/var/www/booknow.hair/server/
          
          echo "Installing backend dependencies on VPS..."
          ssh -o StrictHostKeyChecking=no $SSH_USER@$SSH_HOST "cd /var/www/booknow.hair/server && set -x && npm install --production"

          echo "Restarting/Starting backend server on VPS..."
          ssh -o StrictHostKeyChecking=no $SSH_USER@$SSH_HOST "cd /var/www/booknow.hair/server && pm2 restart booknow-hair-server || pm2 start server.js --name booknow-hair-server"
          
          echo "Configuring Nginx..."
          scp -o StrictHostKeyChecking=no nginx/booknow.hair-http $SSH_USER@$SSH_HOST:/tmp/booknow.hair-nginx.conf
          scp -o StrictHostKeyChecking=no nginx/booknow.hair $SSH_USER@$SSH_HOST:/tmp/booknow.hair-https-nginx.conf
          scp -o StrictHostKeyChecking=no deploy-nginx.sh $SSH_USER@$SSH_HOST:/tmp/deploy-nginx.sh
          scp -o StrictHostKeyChecking=no setup-ssl.sh $SSH_USER@$SSH_HOST:/tmp/setup-ssl.sh
          ssh -o StrictHostKeyChecking=no $SSH_USER@$SSH_HOST "chmod +x /tmp/deploy-nginx.sh && /tmp/deploy-nginx.sh"
          # Triggering a new workflow run after adding deploy-nginx.sh and setup-ssl.sh to git
